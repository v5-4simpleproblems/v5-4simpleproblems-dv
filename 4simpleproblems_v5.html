<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - VERSION 5 CLIENT</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/npm/4sp-dv@latest/images/logo.png">

    <base href="https://cdn.jsdelivr.net/npm/4sp-dv@1.0.27/logged-in/">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
    body { 
        background-color: #040404; 
        color: #c0c0c0; 
        font-family: 'Geist', sans-serif; 
        height: 100vh; 
        margin: 0; 
        display: flex; 
        flex-direction: column; 
        font-weight: 300;
    }
    
    h1, h2, h3, .font-bold, .font-semibold, strong, b, .tracking-widest {
        font-weight: 400 !important;
    }

    #app-frame { width: 100%; height: 100%; border: none; display: none; flex-grow: 1; }
    .hidden { display: none !important; }

    /* --- Navbar Styles --- */
    #navbar-container {
        background: var(--navbar-bg, #000000);
        border-bottom: 1px solid var(--navbar-border, #1f2937);
        height: 64px;
        width: 100%;
        display: none; /* Hidden until unlocked */
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        box-sizing: border-box;
        flex-shrink: 0;
        z-index: 60; 
        transition: background-color 0.3s ease, border-color 0.3s ease;
        position: relative; 
    }

    /* --- FIXED OVERLAY LOGIC --- */
    body.nav-overlay-mode #navbar-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: var(--navbar-bg, rgba(0, 0, 0, 0.6)); 
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--navbar-border, rgba(255, 255, 255, 0.08));
    }

    body.nav-overlay-mode #app-frame {
        height: 100vh; 
        margin-top: 0; 
    }

    .navbar-logo { height: 40px; width: auto; transition: filter 0.3s ease; }
    
    /* --- GLIDE / SCROLL STYLES --- */
    .tab-wrapper { 
        flex-grow: 1; 
        display: flex; 
        align-items: center; 
        position: relative; 
        min-width: 0; 
        margin: 0 1rem; 
        justify-content: center; 
        overflow: hidden; 
    }

    .tab-scroll-container { 
        display: flex; 
        align-items: center; 
        gap: 0.5rem; 
        overflow-x: auto; 
        scrollbar-width: none; 
        white-space: nowrap; 
        max-width: 100%;
        scroll-behavior: smooth; 
        padding-left: 20px;      
        padding-right: 20px;
        padding-block: 10px;
    }
    .tab-scroll-container::-webkit-scrollbar { display: none; }

    /* Glide Buttons */
    .scroll-glide-button {
        position: absolute; 
        top: 0; 
        height: 100%; 
        width: 60px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: #ffffff; 
        font-size: 1rem; 
        cursor: pointer; 
        opacity: 1; 
        transition: opacity 0.3s, color 0.3s ease; 
        z-index: 55; 
        pointer-events: auto;
        background: transparent;
        border: none;
    }

    #glide-left { 
        left: 0; 
        background: linear-gradient(to right, var(--navbar-bg, #000000) 30%, transparent); 
        justify-content: flex-start; 
        padding-left: 8px; 
    }
    #glide-right { 
        right: 0; 
        background: linear-gradient(to left, var(--navbar-bg, #000000) 30%, transparent); 
        justify-content: flex-end; 
        padding-right: 8px; 
    }
    
    .scroll-glide-button.hidden { opacity: 0 !important; pointer-events: none !important; }

    .nav-tab { 
        padding: 0.5rem 1rem; 
        color: var(--tab-text, #9ca3af); 
        font-size: 0.875rem; font-weight: 400; 
        border-radius: 12px; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;
        border: 1px solid transparent; transition: all 0.2s; cursor: pointer;
        flex-shrink: 0; 
        position: relative;
    }
    .nav-tab:hover { 
        color: var(--tab-hover-text, #ffffff); 
        background-color: var(--tab-hover-bg, rgba(79, 70, 229, 0.05));
        border-color: var(--tab-hover-border, transparent);
        transform: translateY(-1px);
        z-index: 50; 
    }
    .nav-tab.active { 
        color: var(--tab-active-text, #4f46e5); 
        border-color: var(--tab-active-border, #4f46e5); 
        background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1)); 
    }
    .nav-tab.active:hover {
        color: var(--tab-active-hover-text, #6366f1);
        border-color: var(--tab-active-hover-border, #6366f1);
        background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
    }
        
    .auth-controls-wrapper { display: flex; align-items: center; gap: 1rem; position: relative; }
    
    .icon-btn {
        width: 40px; height: 40px; border-radius: 50%; border: 1px solid #4b5563; 
        display: flex; align-items: center; justify-content: center; color: #d1d5db; 
        cursor: pointer; background: transparent; transition: background 0.2s; position: relative;
    }
    .icon-btn:hover { 
        background-color: #374151; color: white;
        z-index: 50;
    }

    /* --- DISABLE ANIMATIONS FOR AUTH BTN --- */
    #auth-btn, #auth-btn:hover, #auth-btn:active {
        transform: none !important;
        transition: none !important;
        background-color: transparent !important;
        z-index: auto !important; 
    }

    /* Auth Menu & Settings */
    .auth-menu {
        position: absolute; right: 0; top: 50px; width: 14rem;
        background: var(--menu-bg, #000); 
        border: 1px solid var(--menu-border, #374151); 
        border-radius: 0.75rem;
        padding: 0.5rem; display: none; flex-direction: column; gap: 0.25rem; z-index: 50;
    }
    .auth-menu.open { display: flex; }
    
    .auth-menu-item {
        display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem;
        color: var(--menu-text, #d1d5db); 
        border-radius: 0.5rem; text-decoration: none; font-size: 0.875rem;
        transition: background 0.15s; cursor: pointer;
    }
    .auth-menu-item:hover { 
        background-color: var(--menu-item-hover-bg, #374151); 
        color: var(--menu-item-hover-text, white); 
    }
    .auth-header { 
        padding: 0.5rem; 
        border-bottom: 1px solid var(--menu-divider, #374151); 
        margin-bottom: 0.25rem; 
    }
    .auth-username { color: var(--menu-username-text, white); font-weight: 400; font-size: 0.9rem; }
    .auth-email { color: var(--menu-email-text, #9ca3af); font-size: 0.75rem; }

    #settings-overlay {
        position: fixed; bottom: 0; left: 0; right: 0; top: 64px;
        background: #040404; z-index: 50; display: flex; flex-direction: column;
    }
    
    #settings-container { display: flex; flex-grow: 1; padding: 20px; overflow: hidden; }

    #settings-sidebar {
        width: 250px; padding-right: 20px; flex-shrink: 0;
        display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
    }

    #settings-main-view {
        flex-grow: 1; padding: 20px; background-color: #0d0d0d;
        border: 1px solid #1a1a1a; border-radius: 0.75rem;
        overflow-y: auto; overflow-x: hidden;
    }

    .btn-toolbar-style {
        background: #000000; border: 1px solid #333; border-radius: 0.75rem;
        color: #d1d5db; padding: 0.5rem 1rem; font-weight: 500; cursor: pointer;
        transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;
        position: relative;
    }
    .btn-toolbar-style:hover {
        background-color: #000000; border-color: #fff; color: #ffffff;
        z-index: 50;
    }
    
    .btn-toolbar-style.btn-primary-override {
        justify-content: center; background-color: rgba(79, 70, 229, 0.1);
        border: 1px solid #4f46e5; color: #4f46e5;
    }
    .btn-toolbar-style.btn-primary-override:hover {
        background-color: rgba(79, 70, 229, 0.15); border-color: #6366f1; color: #6366f1;
    }

    .btn-toolbar-style.btn-primary-override-danger {
        justify-content: center; background-color: rgba(220, 38, 38, 0.1);
        border: 1px solid #dc2626; color: #dc2626;
    }
    .btn-toolbar-style.btn-primary-override-danger:hover {
        background-color: rgba(220, 38, 38, 0.15); border-color: #ef4444; color: #ef4444;
    }

    .settings-tab { width: 100%; justify-content: flex-start; }
    .settings-tab.active {
        background-color: rgba(79, 70, 229, 0.1); border: 1px solid #4f46e5; color: #4f46e5;
    }
    .settings-tab.active:hover {
        background-color: rgba(79, 70, 229, 0.15); border-color: #6366f1; color: #6366f1;
    }

    /* --- DISABLE ANIMATIONS FOR SETTINGS TABS --- */
    .settings-tab, .settings-tab:hover, .settings-tab:active {
        transition: none !important;
        transform: none !important;
        animation: none !important;
    }

    .settings-box { 
        border: 1px solid #333; border-radius: 1rem; 
        background-color: #000000; padding: 1.5rem; margin-bottom: 1.5rem;
    }
    
    .input-text-style, .input-select-style {
        width: 100%; padding: 0.75rem; border: 1px solid #252525; 
        background-color: #111111; border-radius: 0.5rem; color: #c0c0c0; transition: all 0.2s;
    }
    .input-text-style:focus, .input-select-style:focus { 
        border-color: #505050; outline: none; box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
    }

    .input-key-style {
        width: 4rem; padding: 0.75rem; border: 1px solid #252525; 
        background-color: #111111; border-radius: 0.5rem; color: #c0c0c0; 
        transition: all 0.2s; font-size: 1.1rem; text-align: center;
        font-weight: 500; text-transform: uppercase; caret-color: transparent;
    }
    .input-key-style:focus {
        border-color: #505050; outline: none; box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
    }
    .input-key-style::placeholder { font-size: 1rem; text-transform: none; }
    
    .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }

    #theme-picker-container {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem; width: 100%;
    }
    .theme-button {
        border: 2px solid var(--tab-active-border, #4f46e5); 
        background-color: #111; border-radius: 0.75rem; padding: 0.75rem; 
        text-align: center; cursor: pointer; transition: all 0.2s ease-out;
        opacity: 0.7; position: relative;
    }
    .theme-button:hover {
        opacity: 1; border-color: var(--tab-active-hover-border, #6366f1);
        transform: translateY(-2px);
    }
    .theme-button.active { opacity: 1; box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); }
    .theme-button-name { font-weight: 500; color: #e0e0e0; }

    /* Cropper */
    #cropperModal {
        display: none; position: fixed; z-index: 2050; left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.85); justify-content: center; align-items: center; flex-direction: column;
    }
    #cropperContent {
        background-color: #000000; padding: 0; border-radius: 1rem; border: 1px solid #333;
        display: flex; flex-direction: column; width: 90%; max-width: 600px; overflow: hidden;
    }
    #cropperCanvasContainer {
        position: relative; margin-bottom: 20px; overflow: hidden; max-height: 60vh;
    }
    #cropperCanvas { display: block; max-width: 100%; max-height: 60vh; border: 1px dashed rgba(255, 255, 255, 0.3); }

    /* --- ANIMATION & THEME VARIABLES --- */
    :root {
        --bg-page: #040404; --bg-container: #000000; --border-color: #333;
        --text-primary: #c0c0c0; --text-light-grey: #d1d5db; --accent-color: #6366f1;
        --navbar-bg: #000000; --navbar-border: #1f2937;
        --tab-text: #9ca3af; --tab-hover-text: #ffffff;
        --tab-active-text: #4f46e5; --tab-active-bg: rgba(79, 70, 229, 0.1);
        --tab-active-border: #4f46e5;
    }

    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px) rotate(-5deg); }
        50% { transform: translateX(5px) rotate(5deg); }
        75% { transform: translateX(-5px) rotate(-5deg); }
        100% { transform: translateX(0); }
    }
    .shake-anim { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

    body.no-animations * {
        transition: none !important; animation: none !important; transform: none !important;
    }

    /* Bubbly Spring Transition */
    body:not(.no-animations) .btn-toolbar-style, 
    body:not(.no-animations) .btn-lock-screen, 
    body:not(.no-animations) .icon-btn, 
    body:not(.no-animations) .nav-tab, 
    body:not(.no-animations) .btn-card-action, 
    body:not(.no-animations) .input-text-style, 
    body:not(.no-animations) .input-lock-screen, 
    body:not(.no-animations) .input-key-style {
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
    }

    body:not(.no-animations) .btn-toolbar-style:active, 
    body:not(.no-animations) .btn-lock-screen:active, 
    body:not(.no-animations) .icon-btn:active, 
    body:not(.no-animations) .nav-tab:active, 
    body:not(.no-animations) .btn-card-action:active {
        transform: scale(0.98); transition: transform 0.05s ease-out !important;
    }

    /* Refined Buttons - Reduced Scale for less clipping/pop */
    .btn-toolbar-style {
        background: #0a0a0a; border: 1px solid #333; border-radius: 14px;
        color: #d1d5db; padding: 0.75rem 1.25rem; font-weight: 500; cursor: pointer;
        display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6); position: relative;
    }
    .btn-toolbar-style:hover {
        transform: scale(1.02) translateY(-1px);
        box-shadow: 0 6px 20px rgba(255, 255, 255, 0.1);
        border-color: #fff; color: #ffffff;
        z-index: 50;
    }

    .btn-lock-screen {
        padding: 0.75rem 1.25rem; font-size: 0.875rem; font-weight: 500; border-radius: 14px;
        color: rgb(99 102 241); background-color: rgba(99, 102, 241, 0.1);
        border: 1px solid rgb(99 102 241); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
        position: relative;
    }
    .btn-lock-screen:hover {
        transform: scale(1.02) translateY(-1px);
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        background-color: rgba(99, 102, 241, 0.2);
        z-index: 50;
    }

    .icon-btn {
        width: 40px; height: 40px; border-radius: 14px;
        border: 1px solid #4b5563; display: flex; align-items: center; justify-content: center; color: #d1d5db; 
        cursor: pointer; background: transparent; position: relative;
    }
    .icon-btn:hover { 
        background-color: #374151; color: white; transform: scale(1.05);
        z-index: 50;
    }

    .btn-card-action {
        display: inline-flex; align-items: center; justify-content: center;
        width: 2rem; height: 2rem; border-radius: 14px;
        background-color: transparent; border: 1px solid transparent;
        color: #9ca3af; cursor: pointer; position: relative;
    }
    .btn-card-action:hover {
        background-color: rgba(79, 70, 229, 0.1); color: #4f46e5; border-color: #4f46e5;
        transform: scale(1.05); z-index: 50;
    }

    .input-text-style:focus, .input-select-style:focus { transform: scale(1.01); }
    .input-lock-screen:focus { transform: scale(1.01); }
    .input-key-style:focus { transform: scale(1.05); }

    .nav-tab { 
        padding: 0.5rem 1rem; color: var(--tab-text); 
        font-size: 0.875rem; font-weight: 400; border-radius: 12px;
        text-decoration: none; display: flex; align-items: center; gap: 0.5rem;
        border: 1px solid transparent; cursor: pointer; background: transparent;
        position: relative;
    }
    .nav-tab:hover { 
        color: var(--tab-hover-text); background-color: rgba(79, 70, 229, 0.05);
        border-color: #4f46e5; transform: scale(1.02);
        z-index: 50;
    }

    .eagler-dropdown {
        position: relative; background-color: rgba(20, 20, 20, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 14px;
        padding: 0.5rem; min-width: 200px; display: inline-block;
    }
    .eagler-dropdown-link {
        display: block; padding: 0.6rem 0.8rem; color: #d1d5db; text-decoration: none;
        border-radius: 14px; font-size: 0.9rem;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .eagler-dropdown-link:hover {
        background-color: rgba(255, 255, 255, 0.1); color: white; transform: translateX(4px);
    }

    /* Notifications */
    .notification-toast {
        background-color: #0a0a0a; border: 1px solid #333; border-radius: 14px;
        padding: 0.75rem 1.25rem; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem;
        min-width: 200px; transform: translateX(120%);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease, background-color 0.2s;
        opacity: 0; pointer-events: auto; cursor: default;
    }
    .notification-toast.show { transform: translateX(0); opacity: 1; }
    .notification-toast.show:hover {
        transform: scale(1.02) translateX(-5px); background-color: #151515;
        border-color: #555; box-shadow: 0 8px 25px rgba(0,0,0,0.7);
    }

    /* UNIVERSAL LOADER CSS */
    #universal-loader {
        pointer-events: none; /* Allows clicks to pass through when hidden/opacity 0 */
    }
    #universal-loader.active {
        pointer-events: auto;
    }
    </style>
</head>
<body>
    <div id="lock-screen" class="w-full h-full flex flex-col items-center justify-center p-4">
        <div class="max-w-5xl w-full bg-[#040404] flex flex-col md:flex-row border border-[#252525] rounded-3xl overflow-hidden shadow-2xl">
            <div class="flex-1 p-8 flex flex-col justify-center items-center border-b md:border-b-0 md:border-r border-[#252525]">
                <h2 class="text-3xl text-[#c0c0c0] mb-6 text-center w-full font-light tracking-tighter">4SP Version 5 Client (DV)</h2>
                <p class="text-[#505050] text-center mb-8 text-sm">Enter your 12-character access code.</p>
                
                <input type="text" id="codeInput" class="w-full max-w-xs bg-[#111] border border-[#252525] text-white rounded-xl p-3 text-center tracking-[0.2em] mb-4 outline-none focus:border-indigo-500 transition" placeholder="XXXX-XXXX-XXXX">
                
                <button id="unlockBtn" class="w-full max-w-xs py-2 px-4 text-sm font-medium rounded-xl text-indigo-500 bg-indigo-500/10 border border-indigo-500 hover:bg-indigo-500/20 transition mb-4">
                    Access
                </button>
                
                <p id="lockMessage" class="text-red-400 text-xs mt-2 min-h-[20px] text-center"></p>
                <p id="loading-text" class="text-gray-500 text-xs mt-2 hidden text-center">Verifying...</p>
            </div>

            <div class="flex-1 p-8 flex flex-col justify-center items-center bg-[#040404]">
                <h2 class="text-3xl text-[#c0c0c0] mb-6 text-center w-full font-light tracking-tighter">How it works</h2>
                <p class="text-lg text-[#505050] mb-8 text-center max-w-md font-light leading-relaxed">
                    This client provides secure, local access to the 4SP suite. Generate a unique code from your web dashboard to log in properly.
                </p>
                
                <a href="https://4sp-organization.github.io/connection.html" target="_blank" class="w-full max-w-xs py-2 px-4 text-sm font-medium rounded-xl text-cyan-500 bg-cyan-500/10 border border-cyan-500 hover:bg-cyan-500/20 transition text-center flex items-center justify-center">
                    Get Your Code
                </a>
            </div>
        </div>
    </div>

    <div id="navbar-container">
        <img src="https://cdn.jsdelivr.net/npm/4sp-asset-library@latest/logo.png" id="navbar-logo" class="navbar-logo" alt="Logo">
        
        <div class="tab-wrapper">
             <button id="glide-left" class="scroll-glide-button hidden"><i class="fa-solid fa-chevron-left"></i></button>
             <div class="tab-scroll-container" id="tabs-container">
                </div>
             <button id="glide-right" class="scroll-glide-button hidden"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="auth-controls-wrapper">
            <div class="relative">
                <button id="auth-btn" class="icon-btn">
                    <i class="fa-solid fa-user"></i>
                </button>
                <div id="auth-menu" class="auth-menu">
                    <div class="auth-header">
                        <div class="auth-username" id="display-username">Client User</div>
                        <div class="auth-email" id="display-email">local@client</div>
                    </div>
                    <a href="#" class="auth-menu-item" onclick="loadPage('settings.html'); return false;">
                        <i class="fa-solid fa-gear w-4"></i> Settings
                    </a>
                    <div class="auth-menu-item text-red-400 hover:text-red-300" id="logout-btn">
                        <i class="fa-solid fa-right-from-bracket w-4"></i> Disconnect
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-overlay" class="hidden">
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                <div id="tab-general" class="settings-section">
                    <h3 class="text-3xl font-bold text-white mb-6">General Settings</h3>
                    
                    <div class="settings-box">
                        <h3 class="text-xl font-bold text-white mb-2">Account Username</h3>
                        <label class="block text-gray-400 text-sm mb-2 font-light">New Username</label>
                        <div class="flex gap-2">
                            <input type="text" id="settings-username-input" class="input-text-style" placeholder="Enter username">
                            <button id="save-username-btn" class="btn-toolbar-style btn-primary-override">Save</button>
                        </div>
                        <p id="username-msg" class="general-message-area text-sm mt-2"></p>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2 mt-6">Organization</h3>
                    <div class="settings-box bg-cyan-500/10 border-cyan-500/50 p-4">
                        <p class="text-sm font-light text-cyan-300 mb-3">
                            Visit the official 4SP Organization website for updates and more tools.
                        </p>
                        <a href="https://4sp-organization.github.io/" target="_blank" class="btn-toolbar-style w-full justify-center bg-cyan-500/10 border-cyan-500 text-cyan-500 hover:bg-cyan-500/20 hover:text-cyan-400">
                            <i class="fa-solid fa-globe mr-2"></i> Visit Website
                        </a>
                    </div>
            
                    <h3 class="text-xl font-bold text-white mb-2 mt-6">Disconnect Client</h3>
                    <div class="settings-box bg-red-900/10 border-red-700/50 p-4">
                        <p class="text-sm font-light text-red-300 mb-3">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                            Disconnect this client from your account. You will need to generate a new code to reconnect.
                        </p>
                        <button id="disconnect-account-btn" class="btn-toolbar-style btn-primary-override-danger w-full justify-center">
                            <i class="fa-solid fa-power-off mr-2"></i> Disconnect Account
                        </button>
                    </div>

                </div>

                <div id="tab-personalization" class="settings-section hidden">
                    <h3 class="text-3xl font-bold text-white mb-6">Personalization</h3>
                    
                    <h3 class="text-xl font-bold text-white mb-2">Profile Picture</h3>
                    <div class="settings-box mb-8 p-4">
                        <div class="flex items-start gap-6">
                            <div class="flex flex-col items-center gap-2">
                                <div id="pfp-preview" class="w-24 h-24 rounded-[32px] bg-gray-700 overflow-hidden border-2 border-[#333] flex items-center justify-center text-3xl font-bold text-white relative">
                                </div>
                                <p class="text-xs text-gray-500">Preview</p>
                            </div>
                            
                            <div class="flex-grow">
                                <div class="flex gap-4 mb-4 border-b border-[#333] pb-4">
                                    <button class="pfp-mode-btn active btn-toolbar-style" data-mode="letter">Letter Avatar</button>
                                    <button class="pfp-mode-btn btn-toolbar-style" data-mode="upload">Upload Image</button>
                                </div>

                                <div id="pfp-letter-options" class="block">
                                    <label class="block text-gray-400 text-xs mb-1 font-light">Custom Text (Max 3)</label>
                                    <div class="flex gap-4 items-center mb-4">
                                        <input type="text" id="pfp-custom-text" maxlength="3" class="input-text-style w-24 text-center uppercase" placeholder="A">
                                        <p class="text-xs text-gray-500">Leave empty to use username initial.</p>
                                    </div>
                                    
                                    <label class="block text-gray-400 text-xs mb-2 font-light">Background Color</label>
                                    <div class="grid grid-cols-5 gap-2 mb-6" id="pfp-color-grid">
                                        <!-- Colors generated by JS -->
                                    </div>
                                    
                                    <button id="save-letter-pfp-btn" class="btn-toolbar-style btn-primary-override w-full justify-center">Set Letter Avatar</button>
                                </div>

                                <div id="pfp-upload-options" class="hidden">
                                    <input type="file" id="pfp-upload-input" accept="image/*" class="hidden"/>
                                    
                                    <button id="trigger-upload-btn" class="btn-toolbar-style mb-4 w-full justify-center">
                                        <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Choose Image...
                                    </button>
                                    
                                    <p class="text-xs text-gray-500 mb-4 text-center">Max size 2MB. Square images work best.</p>
                                    <button id="save-upload-pfp-btn" class="btn-toolbar-style btn-primary-override w-full justify-center">Upload & Set</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2">Navigation Bar Theme</h3>
                    <div class="settings-box p-4">
                        <div id="theme-picker-container">
                        </div>
                    </div>
                </div>

                <div id="tab-privacy" class="settings-section hidden">
                    <h3 class="text-3xl font-bold text-white mb-6">Privacy & Security</h3>
                    
                    <h3 class="text-xl font-bold text-white mb-2">Panic Key Settings</h3>
                    <div class="settings-box p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Configure up to 3 panic keys. Pressing the specified key (without Shift, Ctrl, or Alt) on any page will redirect you to the URL you set.
                            <br>
                            <span class="text-yellow-400">Valid keys:</span> a-z, 0-9, and &#96; - = [ ] \ ; ' , . /
                        </p>
                        
                        <div class="flex items-center gap-4 px-2 mb-2">
                            <label class="block text-gray-400 text-sm font-light" style="width: 4rem; text-align: center;">Key</label>
                            <label class="block text-gray-400 text-sm font-light flex-grow">Redirect URL</label>
                        </div>

                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey1" data-key-id="1" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl1" class="input-text-style" placeholder="e.g., https://google.com">
                        </div>
                        
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey2" data-key-id="2" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl2" class="input-text-style" placeholder="e.g., https://youtube.com/feed/subscriptions">
                        </div>
                        
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey3" data-key-id="3" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl3" class="input-text-style" placeholder="e.g., https://wikipedia.org">
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 border-t border-[#252525]">
                            <p id="panicKeyMessage" class="general-message-area text-sm"></p>
                            <button id="applyPanicKeyBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Keys
                            </button>
                        </div>
                    </div>
                </div>

                <div id="tab-about" class="settings-section hidden">
                    <h3 class="text-3xl font-bold text-white mb-6">About 4SP</h3>
                    <div class="settings-box p-6 flex flex-col items-center text-center">
                        <img src="https://cdn.jsdelivr.net/npm/4sp-asset-library@latest/logo.png" class="h-24 mb-4" alt="Logo">
                        <h1 class="text-3xl font-bold text-white mb-2">(4SP) 4simpleproblems</h1>
                        <p class="text-gray-400 mb-6 max-w-lg font-light">From a soundboard, to a full downloadable client of a platform.</p>
                        
                        <div class="inline-block bg-[#0a0a0a] border border-[#333] px-4 py-2 rounded-[14px] mb-8">
  <span class="text-gray-500 text-sm">Version:</span>
  <span class="text-indigo-400 font-mono font-bold ml-2">5.0.0 (DV)</span>
</div>

                        
                        <div class="flex gap-4">
                            <a href="https://github.com/4simpleproblems-v5" class="text-gray-400 hover:text-white transition"><i class="fa-brands fa-github fa-xl"></i></a>
                            <a href="https://youtube.com/4simpleproblems" class="text-gray-400 hover:text-white transition"><i class="fa-brands fa-youtube fa-xl"></i></a>
                            <a href="https://x.com/@4simpleproblems" class="text-gray-400 hover:text-white transition"><i class="fa-brands fa-discord fa-xl"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="cropperModal">
        <div id="cropperContent">
            <div class="flex justify-between items-center p-6 border-b border-[#333] bg-black">
                <h3 class="text-2xl font-bold text-white">Adjust Profile Picture</h3>
                <button id="cancelCropBtn" class="btn-toolbar-style w-10 h-10 flex items-center justify-center p-0 rounded-xl">
                     <i class="fa-solid fa-xmark fa-xl"></i>
                </button>
            </div>
            <div class="flex flex-col items-center p-6 bg-[#0a0a0a]">
                <p class="text-sm text-gray-400 mb-4">Drag to move. Scroll to resize.</p>
                <div id="cropperCanvasContainer" class="relative mb-6 border border-[#333] rounded-lg overflow-hidden w-full flex justify-center bg-black">
                    <canvas id="cropperCanvas"></canvas>
                </div>
                <div class="flex justify-end w-full">
                    <button id="submitCropBtn" class="btn-toolbar-style btn-primary-override px-6 py-2 rounded-xl">
                        <i class="fa-solid fa-check mr-2"></i> Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="universal-loader" class="fixed inset-0 bg-[#000000] z-[9999] opacity-0 flex flex-col items-end justify-end p-12 transition-opacity duration-200 hidden">
        <img src="https://cdn.jsdelivr.net/npm/4sp-asset-library@latest/logo.png" class="absolute top-6 right-6 h-12 w-auto opacity-50" alt="Logo">
        <div class="flex flex-col items-end gap-2">
            <h2 id="loader-title" class="text-white text-3xl font-light italic font-[Geist]">Loading...</h2>
            <div class="w-64 h-1 bg-[#333] rounded-full overflow-hidden">
                <div id="loader-bar" class="h-full bg-white w-0 transition-all duration-1000 ease-out"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZBKAckVa4IMvJGjcyndZx6Y1XD52lgro",
            authDomain: "project-zirconium.firebaseapp.com",
            projectId: "project-zirconium",
            storageBucket: "project-zirconium.firebasestorage.app",
            messagingSenderId: "1096564243475",
            appId: "1:1096564243475:web:6d0956a70125eeea1ad3e6",
            measurementId: "G-1D4F692C1Q"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Added for admin keybinds

        const lockScreen = document.getElementById('lock-screen');
        const navbar = document.getElementById('navbar-container');
        let appFrame = document.getElementById('app-frame');
        const codeInput = document.getElementById('codeInput');
        const unlockBtn = document.getElementById('unlockBtn');
        const lockMessage = document.getElementById('lockMessage');
        const loadingText = document.getElementById('loading-text');
        
        // Navbar elements
        const tabsContainer = document.getElementById('tabs-container');
        const glideLeft = document.getElementById('glide-left');
        const glideRight = document.getElementById('glide-right');
        
        // Auth Elements
        const authBtn = document.getElementById('auth-btn');
        const authMenu = document.getElementById('auth-menu');
        const logoutBtn = document.getElementById('logout-btn');
        const displayUsername = document.getElementById('display-username');
        const displayEmail = document.getElementById('display-email');

        const BASE_URL = 'https://cdn.jsdelivr.net/npm/4sp-dv@1.0.27/logged-in/';
        const STORAGE_KEY = 'local_access_code';
        const USER_DATA_KEY = 'local_user_data';
        const LAST_PAGE_KEY = 'local_last_page';
        const OWNER_EMAIL = "4simpleproblems@gmail.com"; // For admin checks

        const PAGE_DATA = {
            "dashboard": { "name": "Dashboard", "icon": "fa-solid fa-house-user", "url": "dashboard.html" },
            "soundboard": { "name": "Soundboard", "icon": "fa-solid fa-volume-up", "url": "soundboard.html" },
            "notes": { "name": "Notes", "icon": "fa-solid fa-sticky-note", "url": "notes.html" },
            "dailyphoto": { "name": "Dailyphoto", "icon": "fa-solid fa-image", "url": "dailyphoto.html" },
            "countdowns": { "name": "Countdowns", "icon": "fa-solid fa-clock", "url": "countdowns.html" },
            "weather": { "name": "Weather", "icon": "fa-solid fa-cloud-sun", "url": "weather.html" },
            "dictionary": { "name": "Dictionary", "icon": "fa-solid fa-book", "url": "dictionary.html" },
            "messenger-v2": { "name": "Messenger", "icon": "fa-solid fa-comments", "url": "messenger-v2.html" },
            "games": { "name": "GAMES", "icon": "fa-solid fa-gamepad", "url": "games.html" },
            "settings": { "name": "Settings", "icon": "fa-solid fa-gear", "url": "settings.html" }
        };

        let currentUser = null;
        let userDataUnsubscribe = null;

        // --- ADMIN KEYBINDS LOGIC (Updated to Match admin_keybinds.js exactly) ---
        function initAdminKeybinds(db, auth, user) {
            console.log("[Admin Keybinds] Initializing for", user.uid);
            let explicitEnabled = true;
            let thirdPartyEnabled = true; // Track third party state
            let lastEnablePressTime = 0;
            let lastThirdPartyEnablePressTime = 0; // Separate timer for third party
            let configUnsubscribe = null;

            // Visual Feedback Helper
            function showAdminToast(message, type = "neutral") {
                const existing = document.getElementById("admin-keybind-toast");
                if (existing) existing.remove();

                const toast = document.createElement("div");
                toast.id = "admin-keybind-toast";

                // Styles matching admin_keybinds.js exactly
                Object.assign(toast.style, {
                    position: "fixed",
                    bottom: "24px",
                    right: "24px",
                    display: "flex",
                    alignItems: "center",
                    gap: "12px",
                    backgroundColor: "rgba(13, 13, 13, 0.95)", // Dark glass effect
                    backdropFilter: "blur(5px)",
                    color: "#c0c0c0", // Light gray text
                    padding: "14px 20px",
                    borderRadius: "12px",
                    border: "1px solid #333", // Dark border
                    fontFamily: "'Geist', 'Roboto', sans-serif",
                    fontSize: "14px",
                    fontWeight: "500",
                    boxShadow: "0 10px 15px -3px rgba(0, 0, 0, 0.5)",
                    zIndex: "9999999",
                    opacity: "0",
                    transform: "translateY(20px)",
                    transition: "all 0.3s cubic-bezier(0.16, 1, 0.3, 1)"
                });

                let iconHtml = '';
                if (type === "success" || type === "green") {
                    toast.style.borderColor = "rgba(34, 197, 94, 0.5)";
                    iconHtml = '<i class="fa-solid fa-check-circle" style="color: #4ade80;"></i>';
                } else if (type === "error" || type === "red") {
                    toast.style.borderColor = "rgba(239, 68, 68, 0.5)";
                    iconHtml = '<i class="fa-solid fa-circle-exclamation" style="color: #f87171;"></i>';
                } else {
                    toast.style.borderColor = "rgba(59, 130, 246, 0.5)";
                    iconHtml = '<i class="fa-solid fa-info-circle" style="color: #60a5fa;"></i>';
                }

                toast.innerHTML = `${iconHtml}<span>${message}</span>`;
                document.body.appendChild(toast);

                requestAnimationFrame(() => {
                    toast.style.opacity = "1";
                    toast.style.transform = "translateY(0)";
                });

                setTimeout(() => {
                    toast.style.opacity = "0";
                    toast.style.transform = "translateY(10px)";
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            function subscribeToConfig() {
                if (configUnsubscribe) return;
                const configRef = doc(db, 'config', 'soundboard');
                configUnsubscribe = onSnapshot(configRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.explicitEnabled !== undefined) {
                            explicitEnabled = data.explicitEnabled;
                            console.log(`[Admin Keybinds] Explicit Enabled: ${explicitEnabled}`);
                        }
                        if (data.thirdPartyEnabled !== undefined) {
                            thirdPartyEnabled = data.thirdPartyEnabled;
                            console.log(`[Admin Keybinds] Third Party Enabled: ${thirdPartyEnabled}`);
                        }
                    } else {
                        console.log("[Admin Keybinds] Config doc missing. Defaulting to TRUE.");
                        explicitEnabled = true;
                        thirdPartyEnabled = true;
                    }
                }, (error) => console.error("Config Listen Error:", error));
            }

            // Init Listener
            subscribeToConfig();

            // EXPOSE GLOBAL TRIGGERS
            window.triggerAdminKeybind = async () => {
                console.log("[Admin Keybinds] Triggered via global function.");
                if (explicitEnabled) {
                    // Logic for disabling (Immediate)
                    console.log("[Admin Keybinds] Disabling explicit sounds...");
                    try {
                        await setDoc(doc(db, 'config', 'soundboard'), { explicitEnabled: false }, { merge: true });
                        showAdminToast("Explicit Sounds: DISABLED", "red");
                        lastEnablePressTime = 0;
                    } catch (err) {
                        console.error("[Admin Keybinds] Failed to disable:", err);
                        showAdminToast("Error: Check Console", "red");
                    }
                } else {
                    // Logic for enabling (Double Press Safety)
                    const now = Date.now();
                    if (now - lastEnablePressTime < 1500) { 
                        console.log("[Admin Keybinds] Enabling explicit sounds...");
                        try {
                            await setDoc(doc(db, 'config', 'soundboard'), { explicitEnabled: true }, { merge: true });
                            showAdminToast("Explicit Sounds: ENABLED", "green");
                            lastEnablePressTime = 0;
                        } catch (err) {
                            console.error("[Admin Keybinds] Failed to enable:", err);
                            showAdminToast("Error: Check Console", "red");
                        }
                    } else {
                        console.log("[Admin Keybinds] Waiting for confirm...");
                        showAdminToast("Press Ctrl+Shift+E again to ENABLE", "blue");
                        lastEnablePressTime = now;
                    }
                }
            };
            
            window.triggerThirdPartyKeybind = async () => {
                console.log("[Admin Keybinds] Triggered Third Party toggle.");
                if (thirdPartyEnabled) {
                    // Disable (Immediate)
                    try {
                        await setDoc(doc(db, 'config', 'soundboard'), { thirdPartyEnabled: false }, { merge: true });
                        showAdminToast("Third Party Sounds: HIDDEN", "red");
                        lastThirdPartyEnablePressTime = 0;
                    } catch (err) {
                        console.error("[Admin Keybinds] Failed to disable:", err);
                        showAdminToast("Error: Check Console", "red");
                    }
                } else {
                    // Enable (Double Press Safety)
                    const now = Date.now();
                    if (now - lastThirdPartyEnablePressTime < 1500) { 
                        try {
                            await setDoc(doc(db, 'config', 'soundboard'), { thirdPartyEnabled: true }, { merge: true });
                            showAdminToast("Third Party Sounds: SHOWN", "green");
                            lastThirdPartyEnablePressTime = 0;
                        } catch (err) {
                            console.error("[Admin Keybinds] Failed to enable:", err);
                            showAdminToast("Error: Check Console", "red");
                        }
                    } else {
                        showAdminToast("Press Ctrl+Shift+F again to SHOW", "blue");
                        lastThirdPartyEnablePressTime = now;
                    }
                }
            };

            // Key Listener (Parent Window)
            window.addEventListener('keydown', async (e) => {
                // Trigger is Ctrl + Shift + E
                if (e.ctrlKey && e.shiftKey && (e.key.toLowerCase() === 'e' || e.code === 'KeyE')) {
                    e.preventDefault();
                    window.triggerAdminKeybind();
                }
                // Trigger is Ctrl + Shift + F
                if (e.ctrlKey && e.shiftKey && (e.key.toLowerCase() === 'f' || e.code === 'KeyF')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    e.stopPropagation();
                    window.triggerThirdPartyKeybind();
                }
            }, { capture: true });
        }

        // --- ANALYTICS LOGIC (Integrated) ---
        function initAnalytics(db, userUid) {
            console.log("Analytics: Initializing...");

            function getSessionId() {
                let sid = sessionStorage.getItem('analytics_session_id');
                if (!sid) {
                    sid = 'sess_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                    sessionStorage.setItem('analytics_session_id', sid);
                }
                return sid;
            }

            const sessionId = getSessionId();
            let isExcluded = sessionStorage.getItem('analytics_is_admin') === 'true';

            // We handle exclusion logic in the main Auth flow, so here we just assume the status passed is correct
            // But we can double check session storage
            
            if (!sessionStorage.getItem('analytics_start_time')) {
                sessionStorage.setItem('analytics_start_time', Date.now());
            }

            window.trackPageView = function() {
                if (isExcluded) return;
                const path = window.location.pathname.replace('/logged-in/', '') || window.lastLoadedPage || 'dashboard.html';
                const pageName = document.title || path;
                
                // For iframe, get path from loaded page
                const finalPath = window.lastLoadedPage || path;

                const docRef = doc(db, 'analytics', sessionId);
                
                // Using Firestore functions imported at top
                setDoc(docRef, {
                    sessionId: sessionId,
                    userAgent: navigator.userAgent,
                    lastActive: serverTimestamp(),
                    visitedPages: arrayUnion({
                        path: finalPath,
                        title: pageName,
                        timestamp: Date.now()
                    }),
                    pageCount: increment(1)
                }, { merge: true }).catch(err => console.error("Analytics Error:", err));
            };

            function updateSession() {
                if (isExcluded) return;
                const docRef = doc(db, 'analytics', sessionId);
                let startTime = parseInt(sessionStorage.getItem('analytics_start_time') || Date.now());
                const now = Date.now();
                const duration = (now - startTime) / 1000; 

                setDoc(docRef, {
                    userId: userUid || 'anonymous',
                    lastActive: serverTimestamp(),
                    duration: duration,
                    startTime: startTime
                }, { merge: true });
            }

            // Start
            window.trackPageView();
            setInterval(updateSession, 10000); 
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') updateSession();
            });
            window.addEventListener('beforeunload', () => updateSession());
        }

        // --- Navbar Logic ---
        function renderNavbar(activePageUrl) {
            const tabsContainerEl = document.getElementById('tabs-container');
            
            // Glide Elements
            const glideLeft = document.getElementById('glide-left');
            const glideRight = document.getElementById('glide-right');

            if (!tabsContainerEl) return;
            tabsContainerEl.innerHTML = '';
            
            let currentPath = activePageUrl.replace(BASE_URL, '');
            
            Object.values(PAGE_DATA).forEach(page => {
                const isAuth = page.url === currentPath;
                const tab = document.createElement('a');
                tab.className = `nav-tab ${isAuth ? 'active' : ''}`;
                tab.innerHTML = `<i class="${page.icon}"></i> ${page.name}`;
                tab.onclick = () => loadPage(page.url);
                tabsContainerEl.appendChild(tab);
            });

            // --- Scroll Glide Logic ---
            const updateScrollGilders = () => {
                const container = tabsContainerEl;
                const leftButton = glideLeft;
                const rightButton = glideRight;
                
                // Only show gliders if scrolling is possible/needed
                if (container.scrollWidth <= container.offsetWidth + 2) {
                    if (leftButton) leftButton.classList.add('hidden');
                    if (rightButton) rightButton.classList.add('hidden');
                    // Center content if few tabs
                    container.style.justifyContent = 'center';
                    return; 
                } else {
                    container.style.justifyContent = 'flex-start';
                }

                if (!container || !leftButton || !rightButton) return;

                const isScrolledToLeft = container.scrollLeft <= 5;
                const maxScrollLeft = container.scrollWidth - container.offsetWidth;
                const isScrolledToRight = (container.scrollLeft + 5) >= maxScrollLeft;

                if (isScrolledToLeft) leftButton.classList.add('hidden');
                else leftButton.classList.remove('hidden');

                if (isScrolledToRight) rightButton.classList.add('hidden');
                else rightButton.classList.remove('hidden');
            };

            // Setup Listeners for Glide
            tabsContainerEl.removeEventListener('scroll', updateScrollGilders); // Clean up old
            tabsContainerEl.addEventListener('scroll', updateScrollGilders);
            window.removeEventListener('resize', updateScrollGilders);
            window.addEventListener('resize', updateScrollGilders);

            if(glideLeft) {
                glideLeft.onclick = () => { tabsContainerEl.scrollLeft = 0; };
            }
            if(glideRight) {
                glideRight.onclick = () => { tabsContainerEl.scrollLeft = tabsContainerEl.scrollWidth; };
            }
            
            // Initial check
            setTimeout(updateScrollGilders, 50);
        }

        // Auth Menu
        if (authBtn) {
            authBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (authMenu) authMenu.classList.toggle('open');
            });
        }

        document.addEventListener('click', (e) => {
            if (authMenu && authBtn && !authMenu.contains(e.target) && !authBtn.contains(e.target)) {
                authMenu.classList.remove('open');
            }
        });

        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(USER_DATA_KEY);
                if (userDataUnsubscribe) userDataUnsubscribe();
                location.reload();
            });
        }

        async function fetchUserData(ownerUid) {
            // Setup Real-time Listener for User Data (PFP Sync)
            if (userDataUnsubscribe) userDataUnsubscribe();

            try {
                // Initial fetch to check admin status (less frequent change)
                 const adminDoc = await getDoc(doc(db, "admins", ownerUid));

                 userDataUnsubscribe = onSnapshot(doc(db, "users", ownerUid), (docSnap) => {
                     if (docSnap.exists()) {
                         const data = docSnap.data();
                         // Merge with existing local data to preserve properties not in basic user doc if any
                         const newUserData = {
                             ...currentUser,
                             uid: ownerUid,
                             username: data.username || "User",
                             email: data.email || "No email",
                             pfpType: data.pfpType,
                             customPfp: data.customPfp,
                             pfpLetterBg: data.pfpLetterBg,
                             letterAvatarText: data.letterAvatarText, 
                             letterAvatarTextColor: data.letterAvatarTextColor, // New Field
                             navbarTheme: data.navbarTheme // Sync theme if updated remotely
                         };
                         
                         localStorage.setItem(USER_DATA_KEY, JSON.stringify(newUserData));
                         updateUIWithUser(newUserData);
                         currentUser = newUserData; // Update global state
                         
                         // If settings overlay is open, we might need to update preview there too
                         if (!document.getElementById('settings-overlay').classList.contains('hidden')) {
                             // Dispatch event or manually update if elements exist
                             const preview = document.getElementById('pfp-preview');
                             if (preview) updateSettingsPfpPreview(newUserData, preview);
                         }
                     }
                 });

                // Check Admin Status (kept separate as it's static usually)
                let isAdmin = false;
                if (currentUser && currentUser.email === OWNER_EMAIL) isAdmin = true;
                if (adminDoc.exists()) isAdmin = true;

                if (isAdmin) {
                    console.log("User is Admin/Superadmin");
                    sessionStorage.setItem('analytics_is_admin', 'true');
                    initAdminKeybinds(db, auth, { uid: ownerUid, email: currentUser?.email });
                } else {
                    sessionStorage.removeItem('analytics_is_admin');
                }

                // Initialize Analytics (After admin check to set exclusion flag)
                initAnalytics(db, ownerUid);

            } catch (e) {
                console.error("Error setting up user listener:", e);
                initAnalytics(db, ownerUid);
            }
        }
        
        // Helper to update the settings panel preview if open
        function updateSettingsPfpPreview(user, previewEl) {
             const pfpType = user.pfpType || 'letter';
             if (pfpType === 'custom' && user.customPfp) {
                previewEl.style.backgroundImage = `url('${user.customPfp}')`;
                previewEl.style.backgroundColor = "transparent";
                previewEl.style.backgroundSize = "cover";
                previewEl.innerText = "";
             } else {
                 const letter = (user.username || 'U').charAt(0).toUpperCase();
                 const bgColor = user.pfpLetterBg || '#3B82F6';
                 previewEl.style.backgroundImage = 'none';
                 previewEl.style.backgroundColor = bgColor;
                 previewEl.innerText = letter;
             }
        }

        function updateUIWithUser(userData) {
            if (!userData) return;
            displayUsername.textContent = userData.username;
            displayEmail.textContent = userData.email;
            
            // Profile Picture Logic
            const pfpType = userData.pfpType || 'letter';
            let pfpHtml = '';
            
            if (pfpType === 'custom' && userData.customPfp) {
                pfpHtml = `<img src="${userData.customPfp}" class="w-full h-full object-cover rounded-[14px]" alt="Profile">`;
            } else {
                // Letter Avatar
                const initial = (userData.username || 'U').charAt(0).toUpperCase();
                const letter = userData.letterAvatarText || initial; // Use custom text or fallback
                const bgColor = userData.pfpLetterBg || '#3B82F6'; // Default blue
                // Adjust font size if length > 1
                const fontSizeClass = letter.length > 2 ? 'text-xs' : (letter.length > 1 ? 'text-sm' : 'text-lg');
                
                pfpHtml = `<div class="w-full h-full rounded-[14px] flex items-center justify-center text-white font-bold ${fontSizeClass}" style="background-color: ${bgColor};">${letter}</div>`;
            }
            
            authBtn.innerHTML = pfpHtml;
            authBtn.style.padding = '0'; // Remove padding to let avatar fill
            authBtn.style.overflow = 'hidden'; // Ensure roundness
            authBtn.style.border = '1px solid #4b5563'; // Maintain border
        }

        // --- Auto-Login Logic ---
        async function checkAutoLogin() {
            const savedCode = localStorage.getItem(STORAGE_KEY);
            if (savedCode) {
                loadingText.classList.remove('hidden');
                unlockBtn.classList.add('hidden');
                codeInput.classList.add('hidden');
                
                try {
                    const docRef = doc(db, "access_codes", savedCode);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists() && docSnap.data().active) {
                        const codeData = docSnap.data();
                        
                        // Check for cached user data first
                        let userData = null;
                        try {
                            userData = JSON.parse(localStorage.getItem(USER_DATA_KEY));
                        } catch(e){}

                        if (userData && userData.uid === codeData.ownerUid) {
                             updateUIWithUser(userData);
                             currentUser = userData;
                        } 
                        
                        // Always fetch fresh to re-verify admin status
                        if (codeData.ownerUid) {
                            await fetchUserData(codeData.ownerUid);
                        }

                        launchApp();
                        return;
                    } else {
                        localStorage.removeItem(STORAGE_KEY);
                        resetLockScreen("Session expired. Please enter code again.");
                    }
                } catch(e) {
                    console.error("Auto-login error:", e);
                    resetLockScreen("Connection failed. Retrying...");
                }
            }
        }

        function resetLockScreen(msg) {
            loadingText.classList.add('hidden');
            unlockBtn.classList.remove('hidden');
            codeInput.classList.remove('hidden');
            lockMessage.innerText = msg || "";
        }

        // --- Unlock Logic ---
        unlockBtn.addEventListener('click', async () => {
            let code = codeInput.value.trim().toUpperCase();
            code = code.replace(/-/g, '');

            if (code.length !== 12) {
                lockMessage.innerText = "Invalid code format (12 characters).";
                return;
            }

            lockMessage.innerText = "";
            unlockBtn.disabled = true;
            unlockBtn.innerText = "Checking...";

            try {
                const docRef = doc(db, "access_codes", code);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    throw new Error("Code not found.");
                }

                const data = docSnap.data();

                if (data.claimed) {
                    if (localStorage.getItem(STORAGE_KEY) === code) {
                        launchApp();
                        return;
                    }
                    throw new Error("This code is already in use.");
                }

                if (!data.active) {
                    throw new Error("Code is inactive.");
                }

                // Claim it!
                await updateDoc(docRef, { claimed: true });
                localStorage.setItem(STORAGE_KEY, code);
                
                // Fetch User Data immediately
                if (data.ownerUid) {
                    await fetchUserData(data.ownerUid);
                }

                launchApp();

            } catch (e) {
                lockMessage.innerText = e.message;
                unlockBtn.disabled = false;
                unlockBtn.innerText = "Login";
            }
        });

        function launchApp() {
            const lockScreenEl = document.getElementById('lock-screen');
            const navbarEl = document.getElementById('navbar-container');
            const appFrameEl = document.getElementById('app-frame');

            if (lockScreenEl) lockScreenEl.classList.add('hidden');
            if (navbarEl) navbarEl.style.display = 'flex';
            if (appFrameEl) appFrameEl.style.display = 'block';
            
            // Determine start page
            let startPage = 'dashboard.html';
            const lastPage = localStorage.getItem(LAST_PAGE_KEY);

            // Priority: Last Page > > Default
            if (lastPage) {
                 const isValid = Object.values(PAGE_DATA).some(p => p.url === lastPage);
                 if (isValid) startPage = lastPage;
            }
            
            loadPage(startPage);
            
            // --- Apply Saved Theme on Startup ---
            try {
                const savedThemeRaw = localStorage.getItem('user-navbar-theme');
                if (savedThemeRaw) {
                    const savedTheme = JSON.parse(savedThemeRaw);
                    applyTheme(savedTheme);
                }
            } catch(e) { console.error("Error applying saved theme:", e); }
        }

        // --- Page Loader ---
        window.loadPage = function(pageName) {
            
            // Trigger Analytics Track on Page Load
            if (window.trackPageView) {
                window.trackPageView();
            }

            // Intercept Settings
            if (pageName === 'settings.html' || pageName === 'settings') {
                window.lastLoadedPage = 'settings.html';
                localStorage.setItem(LAST_PAGE_KEY, 'settings.html');
                renderNavbar(BASE_URL + 'settings.html');
                
                // Ensure overlay mode is OFF for settings (per request)
                document.body.classList.remove('nav-overlay-mode');
                
                openSettings();
                return;
            }
            
            // Close Settings if open
            const settingsOverlay = document.getElementById('settings-overlay');
            if (settingsOverlay) settingsOverlay.classList.add('hidden');

            // --- UNIVERSAL LOADER LOGIC ---
            // Normalize page name to find title
            let cleanPageName = pageName;
            if (cleanPageName.startsWith('./')) cleanPageName = cleanPageName.substring(2);
            if (cleanPageName.startsWith(BASE_URL)) cleanPageName = cleanPageName.substring(BASE_URL.length);
            // remove query params for lookup
            let lookupName = cleanPageName.split('?')[0].replace('.html', '');
            
            const loader = document.getElementById('universal-loader');
            const loaderTitle = document.getElementById('loader-title');
            const loaderBar = document.getElementById('loader-bar');
            
            if (loader && loaderTitle && loaderBar) {
                // Determine Title
                let pageTitle = "Loading...";
                const pageEntry = Object.values(PAGE_DATA).find(p => p.url === cleanPageName || p.url.includes(lookupName));
                if (pageEntry) pageTitle = pageEntry.name;
                
                loaderTitle.textContent = pageTitle;
                
                // Show Loader
                loader.classList.remove('hidden');
                // Trigger reflow/anim
                requestAnimationFrame(() => {
                    loader.classList.remove('opacity-0');
                    loader.classList.add('active');
                    loaderBar.style.width = "70%"; // Start animation
                });
            }

            // Normalize path
            if (pageName.startsWith('./')) pageName = pageName.substring(2);
            if (pageName.startsWith('../')) pageName = pageName.substring(3);
            if (pageName.startsWith(BASE_URL)) pageName = pageName.substring(BASE_URL.length);

            // --- OVERLAY LOGIC SWITCH ---
            // If page is 'games.html', 'settings.html', or 'messenger-v2.html', do NOT use overlay mode.
            if (pageName.includes('games') || pageName.includes('settings') || pageName.includes('messenger')) {
                document.body.classList.remove('nav-overlay-mode');
            } else {
                document.body.classList.add('nav-overlay-mode');
            }
            // ---------------------------

            window.lastLoadedPage = pageName;
            localStorage.setItem(LAST_PAGE_KEY, pageName);
            renderNavbar(pageName);

            // Normal fetch flow for ALL pages
            const url = BASE_URL + pageName;
            
            fetch(url)
                .then(res => res.text())
                .then(html => {
                    const oldFrame = document.getElementById('app-frame');
                    const newFrame = document.createElement('iframe');
                    newFrame.id = 'app-frame';
                    
                    if (oldFrame) {
                        newFrame.style.cssText = oldFrame.style.cssText;
                        if (oldFrame.parentNode) {
                            oldFrame.parentNode.replaceChild(newFrame, oldFrame);
                        }
                    } else {
                        newFrame.style.width = '100%';
                        newFrame.style.height = '100%';
                        newFrame.style.border = 'none';
                        newFrame.style.display = 'block';
                        newFrame.style.flexGrow = '1';
                        document.body.appendChild(newFrame);
                    }
                    
                    appFrame = newFrame; 
                    
                    // Loader completion logic
                    newFrame.onload = () => {
                         if (loaderBar) loaderBar.style.width = "100%";
                         setTimeout(() => {
                             if (loader) {
                                 loader.classList.add('opacity-0');
                                 loader.classList.remove('active');
                                 setTimeout(() => {
                                     loader.classList.add('hidden');
                                     if(loaderBar) loaderBar.style.width = "0%";
                                 }, 200);
                             }
                         }, 200);
                    };

                    const doc = newFrame.contentWindow.document;
                    doc.open();
                    
                    const baseTag = '<base href="' + BASE_URL + '">';
                    
                    const patchScript = `
                        <script>
                            window._LOCAL_MODE = true;
                            window._CURRENT_PAGE_NAME = "${pageName}";
                            
                            window.currentUser = {
                                uid: '${currentUser ? currentUser.uid : "client-user"}',
                                displayName: '${currentUser ? currentUser.username : "Client User"}',
                                email: '${currentUser ? currentUser.email : "local@client"}',
                                photoURL: null,
                                providerData: []
                            };

                            // --- Parent Communication ---
                            window.openSettings = function() {
                                window.parent.openSettings();
                            };
                            
                            function notifyParentTyping() {
                                if (window.parent && window.parent.playTypeSound) {
                                    window.parent.playTypeSound();
                                }
                            }

                            window.addEventListener('keydown', function(e) {
                                // Forward Panic
                                if(window.parent.handlePanic) window.parent.handlePanic(e);

                                // Forward Admin Keybind (Ctrl + Shift + E) - Explicit Check
                                if (e.ctrlKey && e.shiftKey && (e.key.toLowerCase() === 'e' || e.code === 'KeyE')) {
                                    e.preventDefault();
                                    if (window.parent.triggerAdminKeybind) window.parent.triggerAdminKeybind();
                                }
                                
                                // Forward Admin Keybind (Ctrl + Shift + F) - Third Party Check
                                if (e.ctrlKey && e.shiftKey && (e.key.toLowerCase() === 'f' || e.code === 'KeyF')) {
                                    e.preventDefault();
                                    e.stopImmediatePropagation();
                                    e.stopPropagation();
                                    if (window.parent.triggerThirdPartyKeybind) window.parent.triggerThirdPartyKeybind();
                                }
                                
                                // Typing Sound (Standard Inputs)
                                const target = e.target;
                                const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA';
                                const isContentEditable = target.isContentEditable;
                                
                                // Ignore non-character keys to avoid spamming sound on navigation
                                const validKey = e.key.length === 1 || e.key === 'Backspace' || e.key === 'Enter';

                                if ((isInput || isContentEditable) && validKey && !e.repeat) {
                                    notifyParentTyping();
                                }
                            }, { capture: true });
                            
                            // Fallback 'input' listener for weird edge cases
                            window.addEventListener('input', function(e) {
                                 // Simple fallback if keydown missed it (e.g. virtual keyboard)
                                 // We rely on parent debouncing
                                 notifyParentTyping();
                            });

                            document.addEventListener('click', e => {
                                const link = e.target.closest('a');
                                if (link && link.href) {
                                    const href = link.getAttribute('href');
                                    // Check if it's settings
                                    if (href.includes('settings.html') || href === '#settings') {
                                        e.preventDefault();
                                        window.parent.openSettings();
                                        return;
                                    }
                                    
                                    e.preventDefault();
                                    window.parent.loadPage(href);
                                }
                            });
                        <\/script>
                    `;
                    
                    let modifiedHtml = html.replace('<head>', '<head>' + baseTag + patchScript);
                    doc.write(modifiedHtml);
                    doc.close();
                })
                .catch(err => {
                    console.error(err);
                    alert("Failed to load page: " + pageName);
                    // Hide loader on error
                    if(loader) loader.classList.add('hidden');
                });
        };

        // --- Settings Logic ---
        const settingsOverlay = document.getElementById('settings-overlay');
        const settingsTabs = document.querySelectorAll('.settings-tab');
        const settingsSections = document.querySelectorAll('.settings-section');
        
        window.openSettings = function() {
            settingsOverlay.classList.remove('hidden');
            loadSettingsData();
        };
        
        // Tab Switching
        settingsTabs.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update buttons
                settingsTabs.forEach(b => {
                    b.classList.remove('active', 'text-white', 'bg-[#1a1a1a]'); 
                    b.classList.add('text-gray-300'); 
                });
                btn.classList.add('active', 'text-white', 'bg-[#1a1a1a]');
                btn.classList.remove('text-gray-300');
                
                // Show Content
                const tabId = btn.dataset.tab;
                settingsSections.forEach(sec => {
                    if (sec.id === `tab-${tabId}`) sec.classList.remove('hidden');
                    else sec.classList.add('hidden');
                });
            });
        });

        // --- Settings Data & Actions ---
        
        // --- 1. General: Username & New Actions ---
        const settingsUsernameInput = document.getElementById('settings-username-input');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const usernameMsg = document.getElementById('username-msg');
        
        // Add Disconnect Listener
        document.getElementById('disconnect-account-btn').addEventListener('click', () => {
             // Re-use existing logout logic
             localStorage.removeItem(STORAGE_KEY);
             localStorage.removeItem(USER_DATA_KEY);
             if (userDataUnsubscribe) userDataUnsubscribe();
             location.reload();
        });

        async function checkProfanity(text) {
            try {
                const res = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                return (await res.text()) === 'true';
            } catch { return false; }
        }

        saveUsernameBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            const newName = settingsUsernameInput.value.trim();
            usernameMsg.innerText = "Checking...";
            usernameMsg.className = "text-gray-500 text-xs mt-2 min-h-[20px]";
            
            if (newName.length < 3 || newName.length > 20) {
                usernameMsg.innerText = "Username must be 3-20 characters.";
                usernameMsg.className = "text-red-400 text-xs mt-2 min-h-[20px]";
                return;
            }
            
            if (await checkProfanity(newName)) {
                usernameMsg.innerText = "Username not allowed.";
                usernameMsg.className = "text-red-400 text-xs mt-2 min-h-[20px]";
                return;
            }
            
            try {
                // Check if taken
                const q = query(collection(db, "users"), where("username", "==", newName));
                const snap = await getDocs(q);
                if (!snap.empty && snap.docs[0].id !== currentUser.uid) {
                    usernameMsg.innerText = "Username taken.";
                    usernameMsg.className = "text-red-400 text-xs mt-2 min-h-[20px]";
                    return;
                }
                
                // Save
                await updateDoc(doc(db, "users", currentUser.uid), { username: newName });
                // Local update happens via onSnapshot listener now
                usernameMsg.innerText = "Saved!";
                usernameMsg.className = "text-green-400 text-xs mt-2 min-h-[20px]";
                
            } catch (e) {
                console.error(e);
                usernameMsg.innerText = "Error saving.";
                usernameMsg.className = "text-red-400 text-xs mt-2 min-h-[20px]";
            }
        });

        // --- 2. Personalization ---
        // Letter Avatar Setup
        // Removed last color (Grey) to make 10 colors (5x2 grid)
        const letterColors = ['EF4444', 'F97316', 'F59E0B', '84CC16', '10B981', '06B6D4', '3B82F6', '6366F1', '8B5CF6', 'EC4899'];
        const pfpModeBtns = document.querySelectorAll('.pfp-mode-btn');
        const pfpLetterOptions = document.getElementById('pfp-letter-options');
        const pfpUploadOptions = document.getElementById('pfp-upload-options');
        const pfpPreview = document.getElementById('pfp-preview');
        const saveLetterPfpBtn = document.getElementById('save-letter-pfp-btn');
        
        // New Inputs
        const pfpCustomText = document.getElementById('pfp-custom-text');
        const pfpCustomColor = document.getElementById('pfp-custom-color');
        const triggerUploadBtn = document.getElementById('trigger-upload-btn');
        
        let pfpState = { mode: 'letter', letterColor: '#3B82F6' };

        pfpModeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                pfpModeBtns.forEach(b => b.classList.remove('active', 'bg-[#222]'));
                btn.classList.add('active', 'bg-[#222]');
                
                const mode = btn.dataset.mode;
                pfpState.mode = mode;
                
                if (mode === 'letter') {
                    pfpLetterOptions.classList.remove('hidden');
                    pfpUploadOptions.classList.add('hidden');
                    updatePfpPreview();
                } else {
                    pfpLetterOptions.classList.add('hidden');
                    pfpUploadOptions.classList.remove('hidden');
                    updatePfpPreview(); // Ensure preview switches if needed
                }
            });
        });
        
        // Render Color Grid
        const gridContainer = document.getElementById('pfp-color-grid');
        gridContainer.innerHTML = ''; 
        
        letterColors.forEach(color => {
            const div = document.createElement('div');
            div.className = 'w-10 h-10 rounded-lg cursor-pointer hover:scale-110 transition border-2 border-transparent';
            div.style.backgroundColor = '#' + color;
            div.onclick = () => {
                pfpState.letterColor = '#' + color;
                updatePfpPreview();
            };
            gridContainer.appendChild(div);
        });

        // Listeners for new inputs
        pfpCustomText.addEventListener('input', () => updatePfpPreview());
        
        // Removed old pfpCustomColor logic

        if (triggerUploadBtn) {
            triggerUploadBtn.addEventListener('click', () => {
                document.getElementById('pfp-upload-input').click();
            });
        }

        function updatePfpPreview() {
            if (pfpState.mode === 'letter') {
                const usernameChar = currentUser ? (currentUser.username || "U").charAt(0).toUpperCase() : "U";
                // Prefer input value, fallback to saved text, fallback to username char
                let displayText = pfpCustomText.value.trim().toUpperCase();
                
                if (!displayText) displayText = usernameChar;

                pfpPreview.style.backgroundImage = 'none';
                pfpPreview.style.backgroundColor = pfpState.letterColor;
                pfpPreview.style.color = '#FFFFFF'; 
                pfpPreview.innerText = displayText;
                // Dynamic font size
                if (displayText.length > 2) pfpPreview.style.fontSize = '1.5rem';
                else if (displayText.length > 1) pfpPreview.style.fontSize = '2rem';
                else pfpPreview.style.fontSize = '3rem';
                
            } else if (pfpState.mode === 'upload') {
                // ... (Existing logic)
                if (currentUser && currentUser.customPfp && currentUser.pfpType === 'custom') {
                    pfpPreview.style.backgroundImage = `url('${currentUser.customPfp}')`;
                    pfpPreview.style.backgroundColor = "transparent";
                    pfpPreview.style.backgroundSize = "cover";
                    pfpPreview.innerText = "";
                } else {
                    const initial = currentUser ? (currentUser.username || "U").charAt(0).toUpperCase() : "U";
                    pfpPreview.style.backgroundImage = 'none';
                    pfpPreview.style.backgroundColor = '#333';
                    pfpPreview.style.color = '#FFFFFF';
                    pfpPreview.innerText = initial;
                    pfpPreview.style.fontSize = '3rem';
                }
            }
        }
        
        saveLetterPfpBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            const textVal = pfpCustomText.value.trim().toUpperCase();
            if (/[<>/\\\\]/.test(textVal)) {
                alert("Invalid characters in avatar text.");
                return;
            }

            saveLetterPfpBtn.innerText = "Saving...";
            try {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    pfpType: 'letter',
                    pfpLetterBg: pfpState.letterColor,
                    letterAvatarColor: pfpState.letterColor, 
                    letterAvatarText: textVal
                });
                saveLetterPfpBtn.innerText = "Saved!";
                setTimeout(() => saveLetterPfpBtn.innerText = "Set Letter Avatar", 2000);
            } catch(e) {
                console.error(e);
                saveLetterPfpBtn.innerText = "Error";
            }
        });

        // --- CROPPER LOGIC ---
        const pfpUploadInput = document.getElementById('pfp-upload-input');
        const saveUploadPfpBtn = document.getElementById('save-upload-pfp-btn');
        const cropperModal = document.getElementById('cropperModal');
        const cropperCanvas = document.getElementById('cropperCanvas');
        const cancelCropBtn = document.getElementById('cancelCropBtn');
        const submitCropBtn = document.getElementById('submitCropBtn');
        const ctx = cropperCanvas.getContext('2d');

        let cropperImage = null;
        let cropState = { x: 0, y: 0, radius: 100 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };

        pfpUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                alert('File is too large (max 2MB).');
                return;
            }

            const reader = new FileReader();
            reader.onload = (evt) => {
                cropperImage = new Image();
                cropperImage.onload = () => {
                    // Setup canvas with fixed height for consistency
                    const fixedHeight = 400;
                    const scale = fixedHeight / cropperImage.height;
                    cropperCanvas.height = fixedHeight;
                    cropperCanvas.width = cropperImage.width * scale;
                    
                    // Initial crop state: center, 1/3 min dim
                    cropState = {
                        x: cropperCanvas.width / 2,
                        y: cropperCanvas.height / 2,
                        radius: Math.min(cropperCanvas.width, cropperCanvas.height) / 3
                    };
                    
                    cropperModal.style.display = 'flex';
                    requestAnimationFrame(drawCropper);
                };
                cropperImage.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        const drawCropper = () => {
            if (!cropperImage) return;
            const w = cropperCanvas.width;
            const h = cropperCanvas.height;
            ctx.clearRect(0, 0, w, h);
            
            // Draw image filling canvas
            ctx.drawImage(cropperImage, 0, 0, w, h);
            
            // Draw overlay
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.beginPath();
            ctx.rect(0, 0, w, h);
            // Cut hole
            ctx.arc(cropState.x, cropState.y, cropState.radius, 0, 2 * Math.PI, true);
            ctx.fill();
            
            // Draw dashed border
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.setLineDash([6, 4]); // Dashed pattern
            ctx.beginPath();
            ctx.arc(cropState.x, cropState.y, cropState.radius, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.setLineDash([]); // Reset
        };

        const handleStart = (x, y) => {
            const dx = x - cropState.x;
            const dy = y - cropState.y;
            if (dx*dx + dy*dy < cropState.radius * cropState.radius) {
                isDragging = true;
                dragStart = { x, y };
            }
        };
        
        const handleMove = (x, y) => {
            if (isDragging) {
                const dx = x - dragStart.x;
                const dy = y - dragStart.y;
                
                let newX = cropState.x + dx;
                let newY = cropState.y + dy;
                
                const r = cropState.radius;
                const w = cropperCanvas.width;
                const h = cropperCanvas.height;
                
                newX = Math.max(r, Math.min(newX, w - r));
                newY = Math.max(r, Math.min(newY, h - r));
                
                cropState.x = newX;
                cropState.y = newY;
                
                dragStart = { x, y };
                requestAnimationFrame(drawCropper);
            }
        };

        const handleEnd = () => { isDragging = false; };
        
        const handleScroll = (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -5 : 5;
            let newRadius = cropState.radius + delta;
            const w = cropperCanvas.width;
            const h = cropperCanvas.height;
            const maxPossibleRadius = Math.min(w, h) / 2;
            newRadius = Math.max(20, Math.min(newRadius, maxPossibleRadius));
            const minX = newRadius;
            const maxX = w - newRadius;
            const minY = newRadius;
            const maxY = h - newRadius;
            cropState.x = Math.max(minX, Math.min(cropState.x, maxX));
            cropState.y = Math.max(minY, Math.min(cropState.y, maxY));
            cropState.radius = newRadius;
            requestAnimationFrame(drawCropper);
        };

        cropperCanvas.addEventListener('mousedown', e => handleStart(e.offsetX, e.offsetY));
        cropperCanvas.addEventListener('mousemove', e => handleMove(e.offsetX, e.offsetY));
        cropperCanvas.addEventListener('mouseup', handleEnd);
        cropperCanvas.addEventListener('mouseleave', handleEnd);
        cropperCanvas.addEventListener('wheel', handleScroll);
        
        cancelCropBtn.addEventListener('click', () => {
            cropperModal.style.display = 'none';
            pfpUploadInput.value = ''; 
        });

        submitCropBtn.addEventListener('click', async () => {
            const tempCanvas = document.createElement('canvas');
            const size = 128; // Output size
            tempCanvas.width = size;
            tempCanvas.height = size;
            const tCtx = tempCanvas.getContext('2d');
            
            const scale = cropperCanvas.height / cropperImage.height;
            const sourceX = (cropState.x - cropState.radius) / scale;
            const sourceY = (cropState.y - cropState.radius) / scale;
            const sourceSize = (cropState.radius * 2) / scale;
            
            tCtx.drawImage(cropperImage, sourceX, sourceY, sourceSize, sourceSize, 0, 0, size, size);
            const base64 = tempCanvas.toDataURL('image/jpeg', 0.8);
            
            // Save to Firestore
            try {
                submitCropBtn.disabled = true;
                submitCropBtn.textContent = "Saving...";
                
                // 1. Update Firestore
                await updateDoc(doc(db, "users", currentUser.uid), { 
                    customPfp: base64,
                    pfpType: 'custom'
                });
                
                // 2. Update Local State Immediately
                currentUser.customPfp = base64;
                currentUser.pfpType = 'custom';
                localStorage.setItem(USER_DATA_KEY, JSON.stringify(currentUser));
                updateUIWithUser(currentUser);
                updateSettingsPfpPreview(currentUser, pfpPreview);
                
                // Update UI Feedback
                cropperModal.style.display = 'none';
                saveUploadPfpBtn.innerText = "Saved!"; // Feedback on the main btn too
            } catch (e) {
                console.error(e);
                alert('Failed to save image.');
            } finally {
                submitCropBtn.disabled = false;
                submitCropBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Submit';
            }
        });
        
        saveUploadPfpBtn.addEventListener('click', () => {
             // Just triggers the file input again if clicked after logic
             pfpUploadInput.click();
        });


        // Theme Logic
        const themeGrid = document.getElementById('theme-picker-container');
        
        async function loadThemes() {
            try {
                const res = await fetch('https://cdn.jsdelivr.net/npm/4sp-dv@latest/themes.json'); 
                if (!res.ok) return;
                let themes = await res.json();
                
                // --- Sorting Logic from settings.js ---
                const orderedThemeNames = ['Dark', 'Light', 'Christmas'];
                const sortedThemes = [];

                orderedThemeNames.forEach(name => {
                    const theme = themes.find(t => t.name === name);
                    if (theme) {
                        sortedThemes.push(theme);
                        themes = themes.filter(t => t.name !== name);
                    }
                });

                const colorMap = {
                    'Crimson': 1, 'Fire': 1, 'Orange': 2, 'Sunset': 2, 'Rust': 2, 'Ember': 2, 'Copper': 2,
                    'Gold': 3, 'Green': 4, 'Forest': 4, 'Matrix': 4, 'Mint': 5, 'Ocean': 6, 'Deep Blue': 6,
                    'Purple': 7, 'Royal': 7, 'Haze': 7, 'Lavender': 7, 'Pink': 8, 'Coral': 8, 'Rose Gold': 8,
                    'Clanker': 9, 'Monochrome': 9, 'Silver': 9, 'Slate': 9
                };
                
                const getThemeType = (t) => (t['logo-src'] && t['logo-src'].includes('logo-dark.png')) ? 1 : 0;

                themes.sort((a, b) => {
                    const colorA = colorMap[a.name] || 100;
                    const colorB = colorMap[b.name] || 100;
                    if (colorA !== colorB) return colorA - colorB;
                    const typeA = getThemeType(a);
                    const typeB = getThemeType(b);
                    if (typeA !== typeB) return typeA - typeB;
                    return a.name.localeCompare(b.name);
                });

                themes = [...sortedThemes, ...themes];
                // --- End Sorting Logic ---

                const savedThemeRaw = localStorage.getItem('user-navbar-theme');
                let savedTheme = null;
                try { if(savedThemeRaw) savedTheme = JSON.parse(savedThemeRaw); } catch(e){}

                themeGrid.innerHTML = '';
                themes.forEach(theme => {
                    const isActive = savedTheme && savedTheme.name === theme.name;
                    const previewBg = theme['navbar-bg'] || '#000000';
                    const previewText = theme['navbar-text'] || '#c0c0c0';
                    const previewBorder = theme['tab-active-border'] || '#4f46e5';

                    const btn = document.createElement('button');
                    btn.className = `theme-button ${isActive ? 'active' : ''}`;
                    btn.style.backgroundColor = previewBg;
                    btn.style.borderColor = previewBorder;
                    btn.innerHTML = `<div class="theme-button-name" style="color: ${previewText};">${theme.name}</div>`;
                    
                    btn.onclick = () => {
                        applyTheme(theme);
                        document.querySelectorAll('.theme-button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    };
                    themeGrid.appendChild(btn);
                });
            } catch(e) { console.error("Themes error", e); }
        }
        
        const lightThemeNames = ['Light', 'Lavender', 'Rose Gold', 'Mint', 'Pink'];

        function applyTheme(theme) {
            const root = document.documentElement;
            
            // --- Logo Path Modification ---
            let logoSrc;
            const isLightTheme = lightThemeNames.includes(theme.name);
            
            if (isLightTheme) {
                logoSrc = 'https://cdn.jsdelivr.net/npm/4sp-dv@latest/images/logo-dark.png'; 
                root.style.setProperty('--menu-username-text', '#000000');
                root.style.setProperty('--menu-email-text', '#444444');
            } else if (theme.name === 'Christmas') {
                logoSrc = 'https://cdn.jsdelivr.net/npm/4sp-dv@latest/images/logo-christmas.png';
                root.style.setProperty('--menu-username-text', 'white');
                root.style.setProperty('--menu-email-text', '#9ca3af');
            } else {
                logoSrc = 'https://cdn.jsdelivr.net/npm/4sp-asset-library@latest/logo.png';
                root.style.setProperty('--menu-username-text', 'white');
                root.style.setProperty('--menu-email-text', '#9ca3af');
            }

            // Apply CSS Variables from theme object (overrides defaults if present)
            for (const [key, value] of Object.entries(theme)) {
                if (key !== 'logo-src' && key !== 'name') {
                    root.style.setProperty(`--${key}`, value);
                }
            }

            // Apply Logo & Tinting
            const logoImg = document.getElementById('navbar-logo');
            if (logoImg) {
                // Update Source (Use absolute path comparison or specific logic)
                // We just set it. Browser handles cache.
                // Note: The original navigation.js checked src endsWith to avoid reload flicker, but simple assignment is okay.
                if (!logoImg.src.includes(logoSrc)) {
                     logoImg.src = logoSrc;
                }

                // Apply Tinting
                const noFilterThemes = ['Dark', 'Light', 'Christmas'];
                if (noFilterThemes.includes(theme.name)) {
                    logoImg.style.filter = ''; 
                    logoImg.style.transform = '';
                } else {
                    const tintColor = theme['tab-active-text'] || '#ffffff';
                    // The original navigation.js used this trick for SVG coloring via filter
                    logoImg.style.filter = `drop-shadow(100px 0 0 ${tintColor})`;
                    logoImg.style.transform = 'translateX(-100px)';
                }
            }

            // Save to local storage for persistence on reload
            localStorage.setItem('user-navbar-theme', JSON.stringify(theme));
            
            // Also update user doc if logged in
            if (currentUser) {
                updateDoc(doc(db, "users", currentUser.uid), { navbarTheme: theme }).catch(console.error);
            }
        }

        // --- 3. Privacy: Panic Key Logic ---
        
        const DB_NAME = 'userLocalSettingsDB';
        const STORE_NAME = 'panicKeyStore';

        // --- IndexedDB Helpers ---
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getPanicKeySettings() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => {
                    const settingsMap = new Map(request.result.map(item => [item.id, item]));
                    db.close();
                    resolve(settingsMap);
                };
                request.onerror = () => {
                     db.close();
                    reject(request.error);
                };
            });
        }
        
        async function savePanicKeySettings(settingsArray) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                let completed = 0;
                const total = settingsArray.length;

                settingsArray.forEach(setting => {
                    const request = store.put(setting);
                    request.onsuccess = () => {
                        completed++;
                        if (completed === total) {
                            db.close();
                            resolve();
                        }
                    };
                    request.onerror = () => {
                         db.close();
                        reject(request.error); 
                    };
                });
                
                if (total === 0) {
                     db.close();
                    resolve();
                }
            });
        }

        // Global store for active keys (in-memory)
        window.activePanicKeys = [];

         async function loadPanicKeys() {
            try {
                const settingsMap = await getPanicKeySettings();
                window.activePanicKeys = []; // Reset
                
                // Populate UI if settings panel is open (though this runs globally too)
                const panicKey1 = document.getElementById('panicKey1');
                const panicUrl1 = document.getElementById('panicUrl1');
                const panicKey2 = document.getElementById('panicKey2');
                const panicUrl2 = document.getElementById('panicUrl2');
                const panicKey3 = document.getElementById('panicKey3');
                const panicUrl3 = document.getElementById('panicUrl3');

                const key1 = settingsMap.get('panicKey1');
                const key2 = settingsMap.get('panicKey2');
                const key3 = settingsMap.get('panicKey3');

                if (key1) {
                    if (panicKey1) panicKey1.value = key1.key || '';
                    if (panicUrl1) panicUrl1.value = key1.url || '';
                    if (key1.key && key1.url) window.activePanicKeys.push(key1);
                }
                if (key2) {
                    if (panicKey2) panicKey2.value = key2.key || '';
                    if (panicUrl2) panicUrl2.value = key2.url || '';
                     if (key2.key && key2.url) window.activePanicKeys.push(key2);
                }
                if (key3) {
                    if (panicKey3) panicKey3.value = key3.key || '';
                    if (panicUrl3) panicUrl3.value = key3.url || '';
                     if (key3.key && key3.url) window.activePanicKeys.push(key3);
                }
            } catch (e) {
                console.error("Error loading panic keys:", e);
            }
        }

        // Panic Key UI Logic
        const applyPanicKeyBtn = document.getElementById('applyPanicKeyBtn');
        const panicKeyMessage = document.getElementById('panicKeyMessage');
        const panicKeyInputs = document.querySelectorAll('.panic-key-input');

        // Input Validation
        const validKeyRegex = /^[a-z0-9`\-=\[\]\\;',\.\/]$/;
        panicKeyInputs.forEach(input => {
            input.addEventListener('keydown', e => {
                if (e.key.length > 1 && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight' && e.key !== 'Tab') {
                    e.preventDefault(); return;
                }
                const lowerKey = e.key.toLowerCase();
                if (lowerKey.length === 1 && !validKeyRegex.test(lowerKey)) {
                     e.preventDefault(); 
                     if(panicKeyMessage) panicKeyMessage.innerHTML = `<span class="text-yellow-400">Invalid key. Only a-z, 0-9, and \` - = [ ] \\ ; ' , . / are allowed.</span>`;
                } else if (lowerKey.length === 1) {
                    e.preventDefault(); input.value = lowerKey; 
                    if(panicKeyMessage) panicKeyMessage.innerText = ''; 
                }
            });
        });

        if (applyPanicKeyBtn) {
            applyPanicKeyBtn.addEventListener('click', async () => {
                if(panicKeyMessage) panicKeyMessage.innerText = '';
                const keys = [
                    document.getElementById('panicKey1').value,
                    document.getElementById('panicKey2').value,
                    document.getElementById('panicKey3').value
                ];
                const urls = [
                    document.getElementById('panicUrl1').value,
                    document.getElementById('panicUrl2').value,
                    document.getElementById('panicUrl3').value
                ];
                
                const settingsToSave = [];
                let hasError = false;

                for (let i = 0; i < 3; i++) {
                    const key = keys[i];
                    let url = urls[i]; 
                    const id = `panicKey${i + 1}`;
                    
                    if (!key && !url) { settingsToSave.push({ id, key: '', url: '' }); continue; }
                    
                    if ( (key && !url) || (!key && url) ) {
                        panicKeyMessage.innerHTML = `<span class="text-red-400">Panic Key ${i+1} is incomplete. Both key and URL must be filled, or both empty.</span>`;
                        hasError = true; break;
                    }

                    if (url.startsWith('/') || url.startsWith('../') || url.startsWith('./')) {
                         panicKeyMessage.innerHTML = `<span class="text-red-400">Panic Key ${i+1} must be a full web address (e.g., google.com).</span>`;
                        hasError = true; break;
                    }

                    if (!url.startsWith('https://') && !url.startsWith('http://')) { url = 'https://' + url; }

                    try { new URL(url); } catch (e) {
                         panicKeyMessage.innerHTML = `<span class="text-red-400">Panic Key ${i+1} has an invalid URL.</span>`;
                        hasError = true; break;
                    }
                    settingsToSave.push({ id, key, url }); 
                }

                if (hasError) return;

                const filledKeys = settingsToSave.map(s => s.key).filter(k => k);
                if (new Set(filledKeys).size !== filledKeys.length) {
                     panicKeyMessage.innerHTML = `<span class="text-red-400">Duplicate panic keys found. Keys must be unique.</span>`;
                    return;
                }
                
                try {
                    applyPanicKeyBtn.disabled = true;
                    panicKeyMessage.innerHTML = `<span class="text-yellow-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...</span>`;
                    await savePanicKeySettings(settingsToSave);
                    panicKeyMessage.innerHTML = `<span class="text-green-400">Panic key settings saved successfully! Reloading...</span>`;
                    setTimeout(() => location.reload(), 1000); 
                } catch (e) {
                    console.error("Error saving panic key settings:", e);
                    panicKeyMessage.innerHTML = `<span class="text-red-400">An error occurred while saving.</span>`;
                } finally {
                    applyPanicKeyBtn.disabled = false;
                }
            });
        }
        
        // --- Global Key Listener for Panic ---
        window.handlePanic = function(e) {
            if (!window.activePanicKeys || window.activePanicKeys.length === 0) return;
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.ctrlKey || e.altKey || e.metaKey || e.shiftKey) return;

            const pressedKey = e.key.toLowerCase();
            const match = window.activePanicKeys.find(s => s.key.toLowerCase() === pressedKey);
            
            if (match && match.url) {
                e.preventDefault();
                e.stopPropagation();
                window.location.href = match.url;
            }
        };
        window.addEventListener('keydown', window.handlePanic);


        // --- Helper: Load Data into Settings ---
        function loadSettingsData() {
            if (currentUser) {
                settingsUsernameInput.value = currentUser.username || "";
                
                // PFP State Init
                pfpState.letterColor = currentUser.pfpLetterBg || '#3B82F6';
                pfpState.mode = currentUser.pfpType === 'custom' ? 'upload' : 'letter';
                
                // Populate Inputs
                pfpCustomText.value = currentUser.letterAvatarText || "";

                // Update UI Buttons to reflect current mode
                pfpModeBtns.forEach(btn => {
                    if (btn.dataset.mode === pfpState.mode) {
                        btn.classList.add('active', 'bg-[#222]');
                        if (pfpState.mode === 'letter') {
                            pfpLetterOptions.classList.remove('hidden');
                            pfpUploadOptions.classList.add('hidden');
                        } else {
                            pfpLetterOptions.classList.add('hidden');
                            pfpUploadOptions.classList.remove('hidden');
                        }
                    } else {
                        btn.classList.remove('active', 'bg-[#222]');
                    }
                });

                updatePfpPreview();
            }
            loadThemes();
            loadPanicKeys(); 
        }

        checkAutoLogin();
        loadPanicKeys(); // Initial load for global listener

    </script>

    <div id="notification-container"></div>
    <script>
    // --- Sound & Notification Logic ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isMuted = false;
    let areAnimationsEnabled = true;

    // EXPOSE PlayTypeSound GLOBALLY
    // Debounce to prevent rapid-fire stuttering if called too fast
    let typeSoundTimeout = null;
    window.playTypeSound = function() {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        // Small debounce
        if (typeSoundTimeout) return;
        typeSoundTimeout = setTimeout(() => { typeSoundTimeout = null; }, 50);

        const bufferSize = audioCtx.sampleRate * 0.02;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;
        const noiseFilter = audioCtx.createBiquadFilter();
        noiseFilter.type = 'bandpass';
        noiseFilter.frequency.value = 3000 + (Math.random() * 1000);
        noiseFilter.Q.value = 1;
        const noiseGain = audioCtx.createGain();
        noiseGain.gain.setValueAtTime(0.04, audioCtx.currentTime);
        noiseGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.01);
        noise.connect(noiseFilter);
        noiseFilter.connect(noiseGain);
        noiseGain.connect(audioCtx.destination);

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(150 + (Math.random() * 50), audioCtx.currentTime);
        gain.gain.setValueAtTime(0.03, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.02);
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        noise.start();
        osc.start();
        noise.stop(audioCtx.currentTime + 0.02);
        osc.stop(audioCtx.currentTime + 0.02);
    };

    function playClickSound() {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(300, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.015);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.015);
    }

    const notificationContainer = document.getElementById('notification-container');
    function showNotification(message, iconClass = 'fa-solid fa-info-circle', type = 'info') {
        if (!notificationContainer) return;
        while (notificationContainer.children.length >= 3) {
            notificationContainer.removeChild(notificationContainer.firstChild);
        }
        const toast = document.createElement('div');
        toast.className = 'notification-toast';
        toast.innerHTML = `<i class="${iconClass} notification-icon ${type}"></i><span>${message}</span>`;
        notificationContainer.appendChild(toast);
        requestAnimationFrame(() => {
            toast.classList.add('show');
            playClickSound();
        });
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { if (toast.parentElement) toast.remove(); }, 300);
        }, 3000);
    }

    // Event Listeners
    document.addEventListener('click', (e) => {
        const target = e.target.closest('button, .nav-tab, .zone-item, .btn-card-action, a, .icon-btn');
        if (target) playClickSound();
    });
    
    document.addEventListener('keydown', (e) => {
        const target = e.target.closest('input, textarea') || e.target.isContentEditable;
        if (target && !e.repeat) window.playTypeSound();
    });
    
    // Copy/Paste Feedback
    document.addEventListener('copy', () => {
        if (window.getSelection().toString().length > 0) showNotification('Copied to clipboard', 'fa-solid fa-copy', 'success');
    });
    document.addEventListener('paste', (e) => {
        if (e.target.closest('input, textarea')) showNotification('Pasted from clipboard', 'fa-solid fa-paste', 'info');
    });
    </script>
</body>
</html>